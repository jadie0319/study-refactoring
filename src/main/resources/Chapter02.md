# Chapter 02 - 리팩터링 원칙

## 2.1 정의

리팩터링
- 정의 : 소프트웨어의 겉보기 동작은 그대로 유지한 채, 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법
- 목적 : 코드를 이해하고 수정하기 쉽게 만드는 것


리팩터링
- 작은 단계들을 거쳐 코드를 수정
- 이런 단계들을 순차적으로 연결하고 큰 변화를 만들어내는 일
- 작은 단계를 진행하더라도 코드는 항상 정상 동작해야 한다
- 작은 단위로 나눠 진행하는 것이 오히려 더 빨리 처리할 수 있다

리팩터링 vs 재구성
- 재구성 : 코드를 정리하거나 구조를 바꾸는 모든 작업
- 리팩터링 : 재구성 중 특수한 한 형태

## 2.2 두 개의 모자

기능 추가 : 기존 코드는 절대 건드리지 않고 새 기능을 추가하기만 한다.  
리팩터링 : 기능 추가는 절대 하지 않고 코드 재구성에만 전념한다. 놓친 테스트 케이스를 발견하지 않는 한 테스트도 새로 만들지 않는다.
부득이 인터페이스를 변경해야 할 때만 기존 테스트를 수정한다.  

## 2.3 리팩터링 이유

### 리팩터링하면 소프트웨어 설계가 좋아진다
- 코드만으로 설계를 파악하기 어려워질수록 설계를 유지하기 어렵고, 부패 속도가 빨라진다.
- 규칙적인 리팩터링은 코드의 구조를 지탱해준다.
- 성능에 영향을 주진 않지만 코드량이 줄면 수정하는데 드는 노력도 줄어든다. 
- 중복 코드를 제거하면 모든 코드가 언제나 고유한 일을 수행함을 보장한다

### 리팩터링을 하면 소프트웨어를 이해하기 쉬워진다
- 리팩터링은 코드가 더 잘읽히게 도와준다.
- 동료 또는 미래의 나를 위한 배려 
  - 코드는 며칠뒤에 다시 봐도 새롭게 느껴질 수 있으므로 다시 분석해야 할 수 있다.
  - 리팩터링을 하면 좀 더 빠르게 분석이 가능
### 리팩터링하면 버그를 쉽게 찾을 수 있다.
### 리팩터링하면 프로그래밍 속도를 높일 수 있다.
- 설계와 가독성이 개선되고 버그가 줄어들면 속도를 높일 수 있다
- 설계가 잘 된 소프트웨어는 새로운 기능을 추가할 지점과 어떻게 고칠지를 쉽게 찾을 수 있다
- 모듈화가 잘 되어 있으면 전체 코드베이스 중 작은 일부만 이해하면 된다

## 2.4 언제 리팩터링 할까?

### 3의 법칙 
1. 처음에는 그냥 한다. 
2. 비슷한 일을 두 번째로 하게 되면 일단 한다
3. 비슷한 일을 세 번째 하게 되면 리팩터링 한다

### 준비를 위한 리팩터링

- 리팩터링하기 가장 좋은 시점은 기능을 추가하기 직전이다
  - 조금 변경하면 다른 작업을 하기 쉬워질 만한 부분 찾는다.
- 예시
  - 오류를 일으키는 코드가 세 곳에 복제되어 퍼져 있다면 한 곳으로 합치는 편이 작업하기 편하다
  - 질의 코드에 섞여 있는 갱신 로직을 분리하면 두 작업이 꼬여서 생기는 오류를 크게 줄일 수 있다

### 이해를 위한 리팩터링

- 적합하지 않은 함수 이름, 변수 이름으로 코드의 의도가 떨어지지 않았는지 파악한다
- 어떤 역할을 하는지 이해된 변수는 적절한 이름으로 바꾸고, 긴 함수는 잘게 나눈다. 
- 그러면 코드가 깔끔해져 보이지 않던 설계가 눈에 들어온다

### 쓰레기 줍기 리팩터링

- 간단히 수정할 수 있는 것은 고치고, 시간이 좀 걸리는 일은 메모후 나중에 처리한다

### 계획된 리팩터링과 수시로 하는 리팩터링

- 위 리팩터링들은 기회가 될 때 진행한다
- 리팩터링 일정을 따로 잡지 않고 프로그래밍 과정에 자연스럽게 녹인다
- 리팩터링은 수시로 해야 하지만, 때론 그동안 못했던 리팩터링 대상들을 계획적으로 진행할 수도 있다.

### 오래 걸리는 리팩터링

- 팀 전체가 리팩터링 작업에 참여하는 것은 회의적. 조금씩 원하는 방향으로 개선한다.
- 리팩터링은 모든 기능이 항상 올바르게 동작하는 것을 보장한다.
  - 기존 코드가 추상 인터페이스를 호출하도록 만들고 나면 쉽게 교체가 가능하다.(추상화로 갈아타기)

### 코드 리뷰에 리팩터링 활용하기

- 코드 리뷰는 개발팀 전체에 지식을 전파하는데 좋다
  - 노하우 전수가 가능하다
  - 시스템의 다양한 측면을 더 많은 사람이 이해하는 데도 도움된다
  - 다른 사람의 관점, 아이디어를 얻을 수 있다
  - 짝 리팩터링 추천

### 관리자에게는 뭐라고 말해야 할까?

- 리팩터링하면 소프트웨어를 빠르게 만드는 데 효과적이다
- 현재 설계가 적합하지 않다면 먼저 리팩터링하고 나서 함수를 추가하는 편이 빠르다
- 리팩터링의 필요성을 아는 관리자는 이해해준다?

### 리팩터링 하지 말아야 할 때

- 외부 API 다루듯 호출해서 쓰는 코드라면 지저분해도 둔다
- 내부 동작을 이해해야 할 시점에 리팩터링해야 효과를 볼 수 있다

## 2.5 리팩터링 시 고려할 문제

### 새 기능 개발 속도 저하

> 리팩터링의 궁극적인 목적은 개발 속도를 높여서, 더 적은 노력으로 더 많은 가치를 창출하는 것이다

- 리팩터링을 더 자주 하도록 노력하여 연습해야 한다
- 리팩터링을 할지 말지를 판단하는 능력은 수년에 걸친 경험을 통해 서서히 형성된다
- 리팩터링을 클린코드나 바람직한 엔지니어링 습관처럼 도적적인 이유로 정당화하지 말아라
  - 본질은 코드베이스를 예쁘게 꾸미는게 아니라 경제적인 이유로 하는 것이다
  - 리팩터링은 개발 기간을 단축하고자 하는 것이다.

### 코드 소유권

- 코드 소유권이 나뉘어 있으면 리팩터링에 방해가 된다
  - 코드 변경의 영향을 주지 않기 위해 노력해야 하므로 힘들다
- 코드의 소유권을 팀에 두는 것이다
- 다른 사람이 수정하지 못하게 막으라는 것이 아니고 자신이 맡은 영역의 변경 사항을 관리해야 한다

### 테스팅

- 잘못된 리팩터링으로 발생한 오류를 잡기 위해 테스트 스위트가 필요하다
- 테스트 코드는 기능 리팩터링, 기능 추가를 도와준다
  - 버그 찾기 쉽다
- 테스트 코드는 리팩터링 불안감을 해소시켜 준다

### 레거시

- 레거시 시스템을 파악할 때 리팩터링이 굉장히 도움된다.
  - 나(마틴 파울러 아님)도 신입때 맡은 도메인 파악을 위해 리팩터링을 진행한 적 있다. 
  - 그때는 단순히 필요한 일이라 생각했지만, 지금 생각해보면 필요한 일 + 레거시 시스템 파악을 위해 일부러 업무를 주신 것 같다
- 프로그램에서 테스트를 추가할 틈새를 찾아서 시스템을 테스트해야 한다 (레거시 코드 활용 전략)

### 데이터베이스

- 데이터베이스 리팩터링은 여러 단계로 나눠서 릴리스 하는 것이 대체로 좋다
  - 새 데이터베이스 필드를 추가만 하고 사용하지 않는다
  - 기존 필드와 새 필드를 동시에 업데이트 하도록 설정한다
  - 데이터베이스를 읽는 클라이언트들을 새 필드를 사용하는 버전으로 조금씩 교체한다
  - 버그 해결, 미사용 코드 정리까지 완료해야 작업의 끝이다

## 2.6 리팩터링, 아키텍처 애그니(YAGNI)

- 앞으로 어느 부분에 유연성이 필요하고 어떻게 해야 그 변화에 가장 잘 대응할 수 있을지 추측하지 않는다
- 현재까지 파악한 요구사항만을 해결하는 소프트웨어를 구축한다. 단 멋지게 해결하도록 설계해야함
- 요구사항을 더 잘 이해하게 되면 그에 맞게 리팩터링한다
  - 호출하는 측에서 항상 같은 값을 넘기는 매개변수는 매개변수 목록에 넣지 않는다.
  - 매개변수를 추가해야 할 시점이 오면 함수 **매개변수화하기**로 해결한다

YAGNI (You aren't going to need it)
- 아키텍처와 설계를 개발 프로세스에 녹이는 방식이며, 리팩터링 없이는 효과를 볼 수 없다
- 나중에 문제를 더 깊이 이해하게 됐을 때 처리하는 방식이 더 낫다
- 진화형 아키텍처 원칙이 발전하는 계기가 됐다.
  - 아키텍처 결정을 시간을 두고 반복해 내릴 수 있다는 장점을 활용하는 패턴과 실천법을 추구

## 2.7 리팩터링과 소프트웨어 개발 프로세스

- 익스트림 프로그래밍 : 지속적 통합, 자가 테스트 코드, 리팩터링 등의 상호 의존 기법들을 하나로 묶은 프로세스
  - 지속적 통합 : 지속적 통합을 적용하면 팀원 각자가 수행한 리팩터링 결과를 빠르게 동료와 공유할 수 있다
  - 자가 테스트 코드 : 오류를 걸러내는 테스트를 자동으로 수행할 수 있어야 한다
  - 리팩터링 : 코드를 이해하고 수정하기 쉽도록 내부 구조를 변경하는 기법
  - 세 실천법을 잘 적용한다면 YAGNI 설계 방식으로 개발을 진행할 수 있다
- TDD : 자가 테스트 코드와 리팩터링을 묶음
- 애자일 : 애자일을 제대로 적용하려면 팀의 역량과 열정이 뒷밤침되어야함

## 2.8 리팩터링과 성능

- 소프트웨어를 빠르게 만드는 비결은, 먼저 튜닝하기 쉽게 만들고 나서 원하는 속도가 나게꿈 튜닝하는 것이다
- 예산 분배 방식
  - 설계를 여러 컴포넌트로 나눠서 컴포넌트마다 자원(시간과 공간) 예산을 할당
  - 컴포넌트는 할당된 자원 예산을 초과할 수 없다
- 성능을 개선하기 위해 코드를 수정하다 보면 다루이 거려운 형태로 변화기 쉽고 개발이 뎌뎌진다
- 대부분 프로그램은 전체 코드 중 극히 일부에서 대부분의 시간을 소비한다
  - 그래서 코드 전체를 고르게 최적화한다면 그중 90%는 효과가 거의 없기 때문에 시간낭비다
- 리팩터링하면 최적화에 도움이 된다
  - 서능 튜닝에 투입할 시간을 벌 수 있다
  - 리팩터링이 잘된 프로그램은 성능을 더 세밀하게 분석할 수 있다.


